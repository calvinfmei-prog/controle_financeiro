<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Finance Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-slate-950 text-slate-200 min-h-screen">

<header class="p-6 border-b border-slate-800">
  <h1 class="text-2xl font-bold">ðŸ’³ Meu Financeiro</h1>
  <p class="text-slate-400">VisÃ£o geral do mÃªs</p>
</header>

<section class="p-6 grid grid-cols-1 md:grid-cols-2 xl:grid-cols-5 gap-6">
  <div class="bg-slate-900 rounded-xl p-5">
    <p class="text-slate-400 text-sm">Saldo Atual</p>
    <h2 id="saldoAtual" class="text-2xl font-bold text-green-400">R$ --</h2>
  </div>

  <div class="bg-slate-900 rounded-xl p-5">
    <p class="text-slate-400 text-sm">Despesas Fixas</p>
    <h2 id="fixas" class="text-2xl font-bold">R$ --</h2>
  </div>

  <div class="bg-slate-900 rounded-xl p-5">
    <p class="text-slate-400 text-sm">Parcelas do MÃªs</p>
    <h2 id="parcelas" class="text-2xl font-bold">R$ --</h2>
  </div>

  <div class="bg-slate-900 rounded-xl p-5">
    <p class="text-slate-400 text-sm">Saldo Projetado</p>
    <h2 id="saldoProjetado" class="text-2xl font-bold">R$ --</h2>
  </div>

  <div class="bg-slate-900 rounded-xl p-5 border border-blue-500">
    <p class="text-slate-400 text-sm">Pode gastar por dia</p>
    <h2 id="gastoDia" class="text-2xl font-bold text-blue-400">R$ --</h2>
  </div>
</section>

<script>
  function parseCSV(text) {
    const lines = text.trim().split('\n')
    const delimiter = lines[0].includes(';') ? ';' : ','
    const headers = lines[0].split(delimiter)

    return lines.slice(1).map(line => {
      const values = line.split(delimiter)
      const obj = {}
      headers.forEach((h, i) => obj[h.trim()] = values[i])
      return obj
    })
  }

  async function fetchCSV(url) {
    const res = await fetch(url)
    const text = await res.text()

    return text
      .trim()
      .split('\n')
      .map(r =>
        r
          .replace(/\r/g, '')
          .split(';') // <-- AQUI ESTÃ A CORREÃ‡ÃƒO
      )
  }

  const BASE =
    'https://docs.google.com/spreadsheets/d/e/2PACX-1vRhxgwGsxs9XuwLPsjDcM2Xg5n28pKU2QdhvMGoPYE3gDovlARrB-28drKVVeMD98mFgZInhTdy8MSM/pub?output=csv'

  async function carregarDashboard() {
    const fixas = await fetchCSV(BASE + '&sheet=Fixas')
    const cartao = await fetchCSV(BASE + '&sheet=Cartao(Parcelado)')
    const config = await fetchCSV(BASE + '&sheet=Config')

    let totalFixas = 0
    fixas.forEach(l => {
      const v = (l['Valor mensal'] || '0')
        .replace('R$', '').replace('.', '').replace(',', '.')
      totalFixas += Number(v)
    })

    let totalParcelas = 0
    cartao.forEach(l => {
      const total = Number(l['NÃºmero de parcelas'])
      const atual = Number(l['Parcela atual'])
      const valor = (l['Valor da parcela'] || '0')
        .replace('R$', '').replace('.', '').replace(',', '.')
      if (atual < total) totalParcelas += Number(valor)
    })

    let saldoInicial = 0
    let gastoMedio = 0
    config.forEach(l => {
      if (l['Saldo Inicial'])
        saldoInicial = Number(l['Saldo Inicial']
          .replace('R$', '').replace('.', '').replace(',', '.'))

      if (l['Gasto MÃ©dio DiÃ¡rio'])
        gastoMedio = Number(l['Gasto MÃ©dio DiÃ¡rio'].replace(',', '.'))
    })

    const saldoProjetado = saldoInicial - totalFixas - totalParcelas

    document.getElementById('saldoAtual').innerText =
      saldoInicial.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})

    document.getElementById('fixas').innerText =
      totalFixas.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})

    document.getElementById('parcelas').innerText =
      totalParcelas.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})

    document.getElementById('saldoProjetado').innerText =
      saldoProjetado.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})

    document.getElementById('gastoDia').innerText =
      gastoMedio.toLocaleString('pt-BR',{style:'currency',currency:'BRL'})
  }

  carregarDashboard()
</script>

</body>
</html>
